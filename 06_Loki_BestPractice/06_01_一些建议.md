
https://juejin.cn/post/6878188974645444621

# 1 尽量使用静态标签

使用静态标签可以在日志时的开销更小。通常日志在发送到Loki之前，在注入label时，常见的推荐静态标签包含：

- 物理机：kubernetes/hosts
- 应用名：kubernetes/labels/app_kubernetes_io/name
- 组件名：kubernetes/labels/name
- 命名空间：kubernetes/namespace
- 其他kubernetes/label/* 的静态标签，如环境、版本等信息

# 2 谨慎使用动态标签

过多的标签组合会造成大量的流，它会让Loki存储大量的索引和小块的对象文件。这些都会显著消耗Loki的查询性能。为避免这些问题，在你知道需要之前不要添加标签！`loki的优势在于并行查询`，使用过滤器表达式`( lable = "text", |~ "regex", …)`来查询日志会更有效，并且速度也很快。

**那么，我该什么时候添加标签？**

`chunk_target_size`默认为1MB，loki将以1MB的压缩后大小来切割日志块，大约等于5MB的原始日志文件（根据你配置的压缩级别来决定）。如果在`max_chunk_age`时间内，你的日志流`足以生成一个或者多个压缩块，那么你可以考虑添加标签，将日志流拆得更细一点`。从Loki 1.4.0开始，有一个指标可以帮助我们了解日志块刷新的情况


#### 2.1.1.1 有界的标签值范围

不管怎样，到最后如果你不得不采用动态标签的话，那你也要`注意控制标签的范围和value值的长度`。举个例子，如果你想将nginx的访问日志提取一些字段后存储到loki，

```less
{"@timestamp":"2020-09-30T12:16:07+08:00","@source":"172.16.1.1","hostname":"node1","ip":"-","client":"172.16.2.1","request_method":"GET","scheme":"https","domain":"xxx.com","referer":"-","request":"/api/v1/asset/asset?page_size=-1&group=23","args":"page_size=-1&group=23","size":975,"status": 200,"responsetime":0.065,"upstreamtime":"0.064","upstreamaddr":"172.16.3.1:8080","http_user_agent":"python-requests/2.22.0","https":"on"}
```

这里面`@source`代表客户端源地址，由于源地址是公网地址，那么在建立loki标签时它的值就是个无界的。 再比如这里面`@request`代表请求URL。可能存在某些请求参数过长，loki的标签值也会过大。如果再将两者相乘，那么这个标签的规模是无法接受的。

以上这种情况是比较属于典型无界的动态标签值，在loki里面我们用`Cardinality`来表述它，`Cardinality值越高，loki的查询效率越低。`。Loki社区给出动态标签的范围应尽量`控制在10以内`。




